<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Latausaikalaskuri ja Hinta-analyysi</title>
    <style>
        :root {
            --font-size-small: 72px;
            --font-size-medium: 80px;
            --font-size-large: 96px;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 18px;
        }
        h2 {
            font-size: var(--font-size-large);
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            font-size: var(--font-size-small);
            display: block;
            margin-bottom: 5px;
        }
        input, button {
            font-size: var(--font-size-small);
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* --- ÄLYKÄS ASETTELU AIKAVÄLILLE --- */
        .time-range {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Sallii rivittymisen jos tila loppuu */
        }
        .time-range div {
            flex: 1;
            min-width: 300px; /* Jos tila on alle 300px per kenttä, ne hyppäävät allekkain */
        }
        
        /* Mobiililaitekohtainen säätö alle 800px leveille näytöille */
        @media screen and (max-width: 800px) {
            .time-range {
                flex-direction: column; /* Pakottaa allekkain mobiilissa */
            }
            .time-range div {
                width: 100%;
            }
        }
        /* ---------------------------------- */

        .result-car {
            border: 2px solid #ccc;
            padding: 10px;
            margin-top: 15px;
        }
        .result-title {
            font-size: var(--font-size-medium);
            font-weight: bold;
            margin-bottom: 5px;
        }
        .result-detail {
            font-size: var(--font-size-small);
            margin-bottom: 5px;
        }
        .optimized {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: normal;
        }
        #price_status {
            font-size: var(--font-size-small);
            margin-top: 10px;
            font-style: italic;
        }
        .help-text {
            font-size: 30px;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h2>Latausaikalaskuri</h2>

    <div class="input-group">
        <label for="charge">Jäljellä oleva lataus (%):</label>
        <input type="number" id="charge" min="0" max="100" required>
    </div>

    <div class="input-group">
        <label for="target">Tavoitelataus (%):</label>
        <input type="number" id="target" min="0" max="100" value="80" required>
    </div>

    <div class="input-group">
        <label>Latausikkuna (24h):</label>
        <p class="help-text">Syötä aika muodossa HH:MM</p>
        <div class="time-range">
            <div>
                <label style="font-size: 40px;">Alkaen</label>
                <input type="text" id="start_time" value="00:00" maxlength="5">
            </div>
            <div>
                <label style="font-size: 40px;">Päättyen</label>
                <input type="text" id="end_time" value="23:59" maxlength="5">
            </div>
        </div>
    </div>

    <div class="input-group">
        <label for="margin">Myyjän marginaali (snt/kWh):</label>
        <input type="number" id="margin" min="0" step="0.01" value="0.30">
    </div>

    <div class="input-group">
        <button onclick="calculateChargingTime()">Laske</button>
    </div>

    <p id="price_status">Ladataan hintoja... ⏳</p>

    <div id="result_etron" class="result-car"></div>
    <div id="result_id4" class="result-car"></div>

    <script>
        let sahkoHinnat = []; 
        const PRICE_STATUS_ELEMENT = document.getElementById('price_status');
        const CAR_MODELS = {
            etron: { name: "Audi e-tron", capacity: 95 }, 
            id4: { name: "VW ID.4", capacity: 77 } 
        };
        const chargingPower = 10.8; 
        const INTERVALS_PER_HOUR = 4;
        const FIXED_INTERVALS = 96;

        const TIME_OPTS = { hour: '2-digit', minute: '2-digit', hour12: false };
        const DATE_OPTS = { day: 'numeric', month: 'numeric' };

        function saveValues() {
            localStorage.setItem('charge_v', document.getElementById('charge').value);
            localStorage.setItem('target_v', document.getElementById('target').value);
            localStorage.setItem('margin_v', document.getElementById('margin').value);
            localStorage.setItem('start_v', document.getElementById('start_time').value);
            localStorage.setItem('end_v', document.getElementById('end_time').value);
        }

        function loadSavedValues() {
            if(localStorage.getItem('charge_v')) document.getElementById('charge').value = localStorage.getItem('charge_v');
            if(localStorage.getItem('target_v')) document.getElementById('target').value = localStorage.getItem('target_v');
            if(localStorage.getItem('margin_v')) document.getElementById('margin').value = localStorage.getItem('margin_v');
            if(localStorage.getItem('start_v')) document.getElementById('start_time').value = localStorage.getItem('start_v');
            if(localStorage.getItem('end_v')) document.getElementById('end_time').value = localStorage.getItem('end_v');
        }

        async function fetchPrices() {
            PRICE_STATUS_ELEMENT.innerText = 'Ladataan hintoja... ⏳';
            let allData = [];
            const now = new Date();

            try {
                let resT = await fetch('https://api.spot-hinta.fi/Today');
                if (resT.ok) allData = (await resT.json()).slice(0, FIXED_INTERVALS);
                
                let resF = await fetch('https://api.spot-hinta.fi/DayForward');
                if (resF.ok) {
                    let dataF = await resF.json();
                    allData = allData.concat(dataF.slice(0, FIXED_INTERVALS));
                }

                sahkoHinnat = allData.map(item => ({
                    price: parseFloat(item.PriceWithTax) * 100,
                    dateTime: new Date(item.DateTime)
                })).filter(item => item.dateTime >= now);

                if (sahkoHinnat.length === 0) throw new Error("Ei tulevia hintoja.");

                const lastItem = sahkoHinnat[sahkoHinnat.length-1].dateTime;
                const lastDate = new Date(lastItem.getTime() + 15 * 60000);
                
                PRICE_STATUS_ELEMENT.innerText = `✅ Hinnat ladattu ${lastDate.toLocaleDateString('fi-FI')} klo ${lastDate.toLocaleTimeString('fi-FI', TIME_OPTS)} asti.`;
                PRICE_STATUS_ELEMENT.style.color = 'green';
            } catch (e) {
                PRICE_STATUS_ELEMENT.innerText = '❌ Virhe hintojen haussa.';
                PRICE_STATUS_ELEMENT.style.color = 'red';
            }
        }

        function calculateChargingTime() {
            saveValues();
            const charge = parseFloat(document.getElementById("charge").value);
            const target = parseFloat(document.getElementById("target").value);
            const margin = parseFloat(document.getElementById("margin").value || 0);
            const startStr = document.getElementById("start_time").value;
            const endStr = document.getElementById("end_time").value;

            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!timeRegex.test(startStr) || !timeRegex.test(endStr)) {
                alert("Syötä kellonaika muodossa HH:MM");
                return;
            }

            if (isNaN(charge) || target <= charge) return;

            const filteredPrices = sahkoHinnat.filter(item => {
                const currentMinutes = item.dateTime.getHours() * 60 + item.dateTime.getMinutes();
                const [sH, sM] = startStr.split(':').map(Number);
                const [eH, eM] = endStr.split(':').map(Number);
                const startLimit = sH * 60 + sM;
                const endLimit = eH * 60 + eM;

                return startLimit <= endLimit 
                    ? (currentMinutes >= startLimit && currentMinutes < endLimit)
                    : (currentMinutes >= startLimit || currentMinutes < endLimit);
            });

            for (const [key, car] of Object.entries(CAR_MODELS)) {
                const energyNeeded = car.capacity * ((target - charge) / 100);
                const intervalsNeeded = Math.ceil((energyNeeded / chargingPower) * INTERVALS_PER_HOUR);
                
                let html = `<div class="result-title">${car.name}</div>
                            <div class="result-detail">Tarve: ${energyNeeded.toFixed(1)} kWh (${Math.floor(intervalsNeeded/4)}h ${intervalsNeeded%4*15}min)</div>`;

                if (intervalsNeeded > filteredPrices.length) {
                    html += `<div class="result-detail warning">Ikkuna liian lyhyt! (${filteredPrices.length * 15} min saatavilla)</div>`;
                } else {
                    let bestSum = Infinity, bestIdx = -1;

                    for (let i = 0; i <= filteredPrices.length - intervalsNeeded; i++) {
                        let sum = 0;
                        for (let j = 0; j < intervalsNeeded; j++) sum += filteredPrices[i+j].price + margin;
                        if (sum < bestSum) { bestSum = sum; bestIdx = i; }
                    }

                    if (bestIdx !== -1) {
                        const start = filteredPrices[bestIdx].dateTime;
                        const end = new Date(start.getTime() + intervalsNeeded * 15 * 60000);
                        const avg = bestSum / intervalsNeeded;

                        html += `<div class="result-detail optimized">Edullisin: ${start.toLocaleDateString('fi-FI', DATE_OPTS)} klo ${start.toLocaleTimeString('fi-FI', TIME_OPTS)} - ${end.toLocaleTimeString('fi-FI', TIME_OPTS)}</div>
                                 <div class="result-detail optimized">Kustannus: ${(avg * energyNeeded / 100).toFixed(2)} € (Ka. ${avg.toFixed(2)} snt/kWh)</div>`;
                    }
                }
                document.getElementById(`result_${key}`).innerHTML = html;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSavedValues(); 
            fetchPrices();
        });
    </script>
</body>
</html>
