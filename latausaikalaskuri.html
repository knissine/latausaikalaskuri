<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latausaikalaskuri</title>
    <style>
        :root {
            --font-size-small: 1.5rem;
            --font-size-medium: 2rem;
            --font-size-large: 2.5rem;
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
        }

        @media screen and (min-width: 800px) {
            :root {
                --font-size-small: 2.2rem;
                --font-size-medium: 3rem;
                --font-size-large: 3.8rem;
            }
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.3;
            color: #333;
        }

        h2 {
            font-size: var(--font-size-large);
            color: var(--primary-blue);
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            font-size: var(--font-size-small);
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        input {
            font-size: var(--font-size-small);
            padding: 15px;
            width: 100%;
            box-sizing: border-box;
            border: 2px solid #ccc;
            border-radius: 8px;
        }

        button {
            font-size: var(--font-size-small);
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
        }

        .time-range {
            display: flex;
            gap: 15px;
            flex-direction: column;
        }

        @media screen and (min-width: 600px) {
            .time-range {
                flex-direction: row;
            }
        }

        .time-range div {
            flex: 1;
        }

        .result-car {
            border: 3px solid #eee;
            padding: 20px;
            margin-top: 25px;
            border-radius: 12px;
            background-color: #fcfcfc;
        }

        .result-title {
            font-size: var(--font-size-medium);
            font-weight: bold;
            color: var(--dark-blue);
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .result-detail {
            font-size: var(--font-size-small);
            margin-bottom: 10px;
        }

        .optimized {
            color: #28a745;
            font-weight: bold;
        }

        .warning {
            color: #dc3545;
        }

        #price_status {
            font-size: 1.2rem;
            margin-top: 15px;
            font-style: italic;
        }

        .help-text {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <h2>Latausaikalaskuri</h2>

    <div class="input-group">
        <label for="charge">Jäljellä oleva lataus (%):</label>
        <input type="text" id="charge" placeholder="0">
    </div>

    <div class="input-group">
        <label for="target">Tavoitelataus (%):</label>
        <input type="text" id="target" value="80">
    </div>

    <div class="input-group">
        <label>Latausikkuna (24h):</label>
        <p class="help-text">HH:MM (esim. 22:00)</p>
        <div class="time-range">
            <div>
                <label style="font-size: 1.1rem; font-weight: normal;">Alkaen</label>
                <input type="text" id="start_time" value="00:00" maxlength="5">
            </div>
            <div>
                <label style="font-size: 1.1rem; font-weight: normal;">Päättyen</label>
                <input type="text" id="end_time" value="23:59" maxlength="5">
            </div>
        </div>
    </div>

    <div class="input-group">
        <label for="margin">Marginaali (snt/kWh):</label>
        <input type="text" id="margin" value="0,30">
    </div>

    <button onclick="calculateChargingTime()">Laske</button>

    <p id="price_status">Ladataan hintoja... ⏳</p>

    <div id="result_etron" class="result-car"></div>
    <div id="result_id4" class="result-car"></div>

    <script>
        let sahkoHinnat = [];
        const CAR_MODELS = {
            etron: { name: "Audi e-tron", capacity: 95 }, 
            id4: { name: "VW ID.4", capacity: 77 } 
        };
        const chargingPower = 10.8;
        const INTERVALS_PER_HOUR = 4;

        // Suomalaiset numeromuotoilut tulostusta varten
        const numFI = new Intl.NumberFormat('fi-FI', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const kwhFI = new Intl.NumberFormat('fi-FI', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

        // Apufunktiot muunnoksiin
        function parseFiFloat(val) {
            if (!val) return 0;
            return parseFloat(String(val).replace(',', '.'));
        }

        function naytaPilkulla(val) {
            if (!val) return "";
            return String(val).replace('.', ',');
        }

        function saveValues() {
            localStorage.setItem('ev_charge', document.getElementById('charge').value);
            localStorage.setItem('ev_target', document.getElementById('target').value);
            localStorage.setItem('ev_margin', document.getElementById('margin').value);
            localStorage.setItem('ev_start', document.getElementById('start_time').value);
            localStorage.setItem('ev_end', document.getElementById('end_time').value);
        }

        function loadValues() {
            // Muutetaan pisteet pilkuiksi ladattaessa, jos selaimen muistissa oli vanhaa dataa
            if(localStorage.getItem('ev_charge')) 
                document.getElementById('charge').value = naytaPilkulla(localStorage.getItem('ev_charge'));
            if(localStorage.getItem('ev_target')) 
                document.getElementById('target').value = naytaPilkulla(localStorage.getItem('ev_target'));
            if(localStorage.getItem('ev_margin')) 
                document.getElementById('margin').value = naytaPilkulla(localStorage.getItem('ev_margin'));
            if(localStorage.getItem('ev_start')) 
                document.getElementById('start_time').value = localStorage.getItem('ev_start');
            if(localStorage.getItem('ev_end')) 
                document.getElementById('end_time').value = localStorage.getItem('ev_end');
        }

        async function fetchPrices() {
            try {
                let resT = await fetch('https://api.spot-hinta.fi/Today');
                let dataT = await resT.json();
                let resF = await fetch('https://api.spot-hinta.fi/DayForward');
                let dataF = resF.ok ? await resF.json() : [];
                
                let allData = dataT.concat(dataF);
                const now = new Date();

                sahkoHinnat = allData.map(item => ({
                    price: parseFloat(item.PriceWithTax) * 100,
                    dateTime: new Date(item.DateTime)
                })).filter(item => item.dateTime >= now);

                if (sahkoHinnat.length > 0) {
                    const last = new Date(sahkoHinnat[sahkoHinnat.length-1].dateTime.getTime() + 15*60000);
                    const status = document.getElementById('price_status');
                    status.innerText = `✅ Hinnat ladattu ${last.toLocaleDateString('fi-FI')} klo ${last.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'})} asti.`;
                    status.style.color = "green";
                }
            } catch (e) {
                document.getElementById('price_status').innerText = "❌ Hintojen haku epäonnistui.";
            }
        }

        function calculateChargingTime() {
            saveValues();
            const charge = parseFiFloat(document.getElementById("charge").value);
            const target = parseFiFloat(document.getElementById("target").value);
            const margin = parseFiFloat(document.getElementById("margin").value);
            const startStr = document.getElementById("start_time").value;
            const endStr = document.getElementById("end_time").value;

            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!timeRegex.test(startStr) || !timeRegex.test(endStr)) {
                alert("Anna aika muodossa HH:MM"); return;
            }

            const [sH, sM] = startStr.split(':').map(Number);
            const [eH, eM] = endStr.split(':').map(Number);
            const startLimit = sH * 60 + sM;
            const endLimit = eH * 60 + eM;

            const filtered = sahkoHinnat.filter(item => {
                const cur = item.dateTime.getHours() * 60 + item.dateTime.getMinutes();
                return startLimit <= endLimit ? (cur >= startLimit && cur < endLimit) : (cur >= startLimit || cur < endLimit);
            });

            for (const [key, car] of Object.entries(CAR_MODELS)) {
                const energy = car.capacity * ((target - charge) / 100);
                const intervals = Math.ceil((energy / chargingPower) * INTERVALS_PER_HOUR);
                let resDiv = document.getElementById(`result_${key}`);

                if (intervals > filtered.length) {
                    resDiv.innerHTML = `<div class="result-title">${car.name} (${car.capacity} kWh)</div><div class="result-detail warning">Latausikkuna liian lyhyt.</div>`;
                    continue;
                }

                let bestSum = Infinity, bestIdx = -1;
                for (let i = 0; i <= filtered.length - intervals; i++) {
                    let sum = 0;
                    for (let j = 0; j < intervals; j++) sum += filtered[i+j].price + margin;
                    if (sum < bestSum) { bestSum = sum; bestIdx = i; }
                }

                const s = filtered[bestIdx].dateTime;
                const e = new Date(s.getTime() + intervals * 15 * 60000);
                const avg = bestSum / intervals;
                const spotAvg = avg - margin; // Lasketaan spot-osuus erikseen näkyviin jos tarpeen

                resDiv.innerHTML = `
                    <div class="result-title">${car.name} (${car.capacity} kWh)</div>
                    <div class="result-detail">Tarve: <strong>${kwhFI.format(energy)} kWh</strong> (${Math.floor(intervals/4)}h ${intervals%4*15}min)</div>
                    <div class="result-detail optimized">Edullisin: klo ${s.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit', hour12:false})} - ${e.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit', hour12:false})}</div>
                    <div class="result-detail optimized">Kustannus: ${numFI.format(avg * energy / 100)} €</div>
                    <div class="help-text" style="font-size: 0.9rem;">(Keskihinta sis. marginaalin: ${numFI.format(avg)} snt/kWh)</div>
                `;            }
        }

        window.onload = () => { 
            loadValues();
            fetchPrices(); 
        };
    </script>
</body>
</html>
