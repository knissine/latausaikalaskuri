<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latausaikalaskuri</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --font-size-small: 1.25rem;
            --font-size-medium: 1.75rem;
            --font-size-large: 2.25rem;
            --primary-blue: #007bff;
            --page-horizontal-padding: 1rem;
            --app-background: #f5f5f7;
        }

        .main-container {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 15px;
            box-sizing: border-box;
            position: relative;
            background-color: var(--app-background);
        }

        body { background-color: var(--app-background); font-family: Arial, sans-serif; margin: 20px 0; line-height: 1.3; }

        h2 { font-size: var(--font-size-large); color: var(--primary-blue); margin-top: 0; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        label { font-size: var(--font-size-small); display: block; font-weight: bold; margin-bottom: 5px; }
        input, select { font-size: var(--font-size-small); padding: 12px; width: 100%; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; color: #111; background: #fff; }
        button { font-size: var(--font-size-small); background-color: var(--primary-blue); color: white; border: none; border-radius: 8px; padding: 20px; width: 100%; cursor: pointer; font-weight: bold; }
        .content-box {background-color: #ffffff; border: 1px solid #ddd; border-radius: 12px; padding: 15px var(--page-horizontal-padding); margin-bottom: 20px; box-sizing: border-box; }
        .result-car { border: 4px solid #28a745; padding: 20px; margin-top: 25px; border-radius: 12px; background-color: #f0fff4; }
        .flex-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; }
        .flex-row > .input-group { flex: 1 1 140px; min-width: 140px; box-sizing: border-box; }
        .small-btn { font-size: 1rem; padding: 8px; background: #6c757d; width: auto; margin: 0; color: #fff; border-radius: 8px; border: none; cursor: pointer; }
        .help { font-size: 0.9rem; color: #555; margin-top: 6px; display:block; }
        .collapse-panel { display: none; margin-top: 10px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #e6e6e6; }
        .collapse-row { display:flex; gap:8px; align-items:center; }
        .collapse-row input { padding:10px; box-sizing: border-box; }
        .collapse-row .name-input { flex: 1 1 280px; min-width: 0; }
        .collapse-row .cap-input { flex: 0 0 110px; width: 110px; }
        .panel-btn {
            padding: 6px 10px; font-size: 0.95rem;
            border-radius: 6px; border: none;
            cursor: pointer;
            min-width: 0; width: auto;
            height: 45px !important;
        }
        .panel-btn.primary { background: var(--primary-blue); color: #fff; }
        .panel-btn.save { background: #28a745; color: #fff; }
        .panel-btn.cancel  { background: #f44336; color: #fff; }
         /* Settings actions: stack buttons vertically and make them full-width */
        .settings-actions { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
        .settings-actions .panel-btn { width:100%; box-sizing:border-box; padding:10px 12px; }
        .settings-menu {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            max-width: 800px;
            background: var(--app-background); z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto;
            border: 2px solid #e6e6e6; border-radius: 12px;
            max-height: 95vh; /* Valikko on max 95% ruudun korkeudesta */
            overflow-y: auto; /* Jos sisältö on yli 85vh, valikko skrollaa sisäisesti */
         }
        .settings-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); /* Tummennus */
            backdrop-filter: blur(5px);    /* Sumennus */
            z-index: 1500;
        }
        #settings-icon {
            z-index: 2100 !important; /* Korkein arvo, jotta näkyy aina */
        }
        .version-info {
            display: block;        /* Vie version omalle rivilleen */
            font-size: 0.8rem;    /* Huomattavasti pienempi kuin h2 */
            font-weight: normal;   /* Poistaa otsikon lihavoinnin versiolta */
            color: #666;           /* Hieman haaleampi väri */
            margin-top: 4px;       /* Pieni rako otsikon ja version välille */
        }

        @media (max-width: 600px) {
            :root { --page-horizontal-padding: 0.75rem; }
            .flex-row { flex-direction: column; gap: 8px; }
            .flex-row > .input-group { flex: 1 1 100%; min-width: 0; }
            input, select, button { padding: 10px; font-size: 1.1rem; }
            .panel-btn { padding: 6px 8px; height: 36px; font-size: 1rem; }
            .collapse-row { flex-direction: column; align-items: stretch; gap:8px; }
            .collapse-row .cap-input { flex: 0 0 auto; width: 100%; }
            .collapse-row .name-input { flex: 1 1 auto; }
            .panel-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="settings-overlay" class="settings-overlay" onclick="toggleSettings()"></div>
    <div class="main-container">

        <div id="settings-icon" onclick="toggleSettings()"
            style="position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; z-index: 2100;">
            ⚙️
        </div>

        <div class="settings-menu" id="settings-menu">
            <h2>Asetukset</h2>
            <hr>

            <div class="content-box">
                <label style="font-weight:bold; display:block; margin-bottom:6px;">Myyntimarginaali (snt/kWh):</label>
                <input type="text" class="finnish-number" id="supplier_margin" inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?"
                    title="Käytä pilkkua desimaalierottimena"
                    style="width:100%; padding:8px; box-sizing:border-box; border:2px solid #ccc; border-radius:6px;">
            </div>

            <div class="content-box">
                <label style="font-weight:bold; display:block; margin-bottom:6px;">Sähkön siirto (snt/kWh):</label>
                <div style="margin-bottom: 12px;">
                    <span style="font-size: 0.8em; display: block; margin-bottom: 4px;">Päiväsiirron hinta (snt/kWh):</span>
                    <input type="text" class="finnish-number" id="transfer_day" inputmode="decimal"
                        style="width:100%; padding:8px; box-sizing:border-box; border:2px solid #ccc; border-radius:6px;">
                </div>

                <div style="margin-bottom: 12px;">
                    <span style="font-size: 0.8em; display: block; margin-bottom: 4px;">Yösiirron hinta (snt/kWh):</span>
                    <input type="text" class="finnish-number" id="transfer_night" inputmode="decimal"
                        style="width:100%; padding:8px; box-sizing:border-box; border:2px solid #ccc; border-radius:6px;">
                </div>
                <label style="font-weight:bold; display:block; margin-bottom:6px;">Yösiirto voimassa (tunnit 0-24):</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="night_start" inputmode="numeric" placeholder="22"
                        style="width:60px; padding:8px; text-align:center; border:2px solid #ccc; border-radius:6px;">
                    <span>–</span>
                    <input type="text" id="night_end" inputmode="numeric" placeholder="07"
                        style="width:60px; padding:8px; text-align:center; border:2px solid #ccc; border-radius:6px;">
                    <span style="font-size: 0.85em; color: #666;">(klo)</span>
                </div>
                <div class="help" style="margin-top:6px;">Muokkaa arvoja (käytä pilkkua) ja paina <strong>Tallenna
                        asetukset</strong>.</div>
            </div>

            <div style="margin: 20px 0;">
                <div class="settings-actions">
                    <button class="panel-btn cancel"  onclick="resetSettings()" >Palauta oletusarvot</button>
                    <button class="panel-btn save"    onclick="saveSettings()"  >Tallenna asetukset</button>
                    <button class="panel-btn primary" onclick="toggleSettings()">Sulje valikko</button>
                </div>
            </div>
        </div>

        <h2>
            Latausaikalaskuri
            <span class="version-info">v. 20260104</span>
        </h2>

        <div id="price_status" class="content-box">Ladataan hintoja...</div>

        <div class="content-box">
            <label>Auto:</label>
            <div class="flex-row">
                <select id="car_select" onchange="saveAll()" style="flex:2"></select>
                <button id="delete_car_btn" onclick="deleteCar()" class="small-btn"
                    style="background:#dc3545">Poista</button>
            </div>

            <div style="margin-top:10px; display:flex; gap:8px;">
                <button id="toggle_add_car" class="small-btn" aria-expanded="false" aria-controls="add_car_panel"
                    onclick="toggleAddCar()" style="background:var(--primary-blue);">
                    Lisää auto
                </button>
                <div class="help" style="margin:0; align-self:center;">Lisää auto vain tarvittaessa</div>
            </div>

            <div id="add_car_panel" class="collapse-panel" aria-hidden="true">
                <div class="collapse-row">
                    <input id="new_car_name" class="name-input" type="text" placeholder="Nimi (esim. Tesla Model 3)"
                        aria-label="Auto nimi">
                    <input id="new_car_cap" class="cap-input" type="number" placeholder="kWh" aria-label="Kapasiteetti kWh"
                        step="0.1">
                    <button class="panel-btn primary" onclick="addCarFromPanel()">Lisää</button>
                    <button class="panel-btn cancel" onclick="closeAddCarPanel()">Peruuta</button>
                </div>
            </div>
        </div>

        <div class="content-box">
            <div class="flex-row">
                <div class="input-group" style="flex:1">
                    <label>Akku nyt %</label>
                    <input type="number" id="charge" value="20">
                </div>
                <div class="input-group" style="flex:1">
                    <label>Tavoite %</label>
                    <input type="number" id="target" value="80">
                </div>
                <div class="input-group" style="flex:1">
                    <label>Latausteho (kW)</label>
                    <input type="text" id="charging_power" value="11" inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?"
                        title="Anna teho kW:ina, voit käyttää pilkkua desimaalierottimena">
                </div>
            </div>

            <div class="input-group">
                <label>Latausikkuna ALKAA:</label>
                <div class="flex-row">
                    <select id="start_day" style="flex:1">
                        <option value="0" selected>Tänään</option>
                        <option value="1">Huomenna</option>
                    </select>
                    <input type="text" id="start_time" value="00:00" style="flex:1">
                </div>
            </div>

            <div class="input-group">
                <label>Latausikkuna PÄÄTTYY:</label>
                <div class="flex-row">
                    <select id="end_day" style="flex:1">
                        <option value="0">Tänään</option>
                        <option value="1" selected>Huomenna</option>
                    </select>
                    <input type="text" id="end_time" value="23:59" style="flex:1">
                </div>
            </div>

            <button onclick="calculate()">LASKE EDULLISIN AIKA</button>
        </div>

        <div id="result" class="content-box" style="display:none;"></div>
    </div>

    <script>
        const defaultCars = [
            { name: "Audi e-tron", capacity: 95 }, { name: "VW ID.4", capacity: 77 }
        ];
        let latausaikalaskuriAppState = getAppState();
        let sahkoHinnat = [];
        let cars = latausaikalaskuriAppState.cars || defaultCars;

        const fiNumber = new Intl.NumberFormat('fi-FI', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
        const fiPrice  = new Intl.NumberFormat('fi-FI', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function parseLocalizedNumber(str) {
            if (str === null || str === undefined) return NaN;
            const cleaned = String(str).trim().replace(/\s+/g, '').replace(',', '.');
            return parseFloat(cleaned);
        }

        async function fetchPrices() {
            const statusBox = document.getElementById('price_status');
            try {
                const response = await fetch('https://api.spot-hinta.fi/TodayAndDayForward');
                if (!response.ok) {
                    throw new Error('Haku epäonnistui: ${response.status}');
                }

                const combinedData = await response.json();

                const uniquePrices = new Map();

                combinedData.forEach(item => {
                    const raw = item.PriceWithTax;
                    const val = parseLocalizedNumber(raw); // expect €/kWh
                    const time = new Date(item.DateTime).getTime();
                    // store raw numeric value (snt/kWh) or NaN if parse failed
                    const sntPerKwh = isFinite(val) ? val * 100 : NaN;
                    if (!uniquePrices.has(time)) {
                        uniquePrices.set(time, {
                            price: sntPerKwh,
                            ts: time,
                            date: new Date(item.DateTime)
                        });
                    }
                });

                sahkoHinnat = Array.from(uniquePrices.values()).sort((a,b) => a.ts - b.ts)
                    .map(p => ({ price: isFinite(p.price) ? p.price : 0, ts: p.ts, date: p.date }));

                if (sahkoHinnat.length > 0) {
                    const last = sahkoHinnat[sahkoHinnat.length - 1].date;
                    statusBox.innerText = `Hinnat ladattu: ${last.getDate()}.${last.getMonth() + 1}. klo ${last.getHours()}:${last.getMinutes().toString().padStart(2, '0')} asti.`;
                    statusBox.style.background = "#d4edda";
                } else {
                    statusBox.innerText = "Hintoja ei saatu ladattua.";
                    statusBox.style.background = "#fff3cd";
                }
            } catch (e) {
                console.error("fetchPrices error", e);
                statusBox.innerText = "❌ Virhe hintojen latauksessa.";
                statusBox.style.background = "#f8d7da";
            }
        }

        function showResultError(msg) {
            const resDiv = document.getElementById('result');
            resDiv.style.display = "block";
            resDiv.innerHTML = `<div style="color:red; font-weight:bold;">${msg}</div>`;

            // sulje mahdollinen fokus ja skrollaa virheen kohdalta näkyviin mobiilissa
            if (document.activeElement && typeof document.activeElement.blur === 'function') {
                document.activeElement.blur();
            }
            setTimeout(() => {
                if (typeof resDiv.scrollIntoView === 'function') {
                    resDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    window.scrollTo({ top: resDiv.offsetTop - 20, behavior: 'smooth' });
                }
            }, 100);
        }

        function calculate() {
            saveAll();

            const selIdx = parseInt(document.getElementById('car_select').value, 10) || 0;
            const car = cars[selIdx] || cars[0];

            const chargeVal = parseFloat(document.getElementById("charge").value);
            const targetVal = parseFloat(document.getElementById("target").value);
            if (!isFinite(chargeVal) || !isFinite(targetVal)) {
                showResultError("Tarkista 'Akku nyt %' ja 'Tavoite %' -kenttien arvot.");
                return;
            }

            const energyNeeded = car.capacity * ((targetVal - chargeVal) / 100);
            if (!isFinite(energyNeeded) || energyNeeded <= 0) {
                showResultError("Laskettava energiantarve on 0 tai virheellinen (tarkista prosentit).");
                return;
            }

            const chargingPower = parseLocalizedNumber(document.getElementById("charging_power").value);
            if (!isFinite(chargingPower) || chargingPower <= 0) {
                showResultError("Virheellinen latausteho. Anna positiivinen numero (kW).");
                return;
            }

            let supplierMargin = parseLocalizedNumber(document.getElementById("supplier_margin").value);
            if (!isFinite(supplierMargin)) supplierMargin = 0;

            let transferDay = parseLocalizedNumber(document.getElementById("transfer_day").value);
            if (!isFinite(transferDay)) transferDay = 0;

            let transferNight = parseLocalizedNumber(document.getElementById("transfer_night").value);
            if (!isFinite(transferNight)) transferNight = 0;

            const totalHoursExact = energyNeeded / chargingPower; // tuntia desimaalina

            if (!isFinite(totalHoursExact) || totalHoursExact <= 0) {
                showResultError("Laskettava energiantarve on 0 tai virheellinen (tarkista prosentit).");
                return;
            }

            const blocksNeeded = Math.ceil(totalHoursExact * 4);

            const now = new Date();
            const getTs = (dayAdd, timeStr, isEnd) => {
                // Pilkotaan syöte, mutta varmistetaan että minuuteille on oletusarvo 0
                const parts = timeStr.split(':').map(Number);
                const h = parts[0];
                const m = parts.length > 1 ? parts[1] : 0; // Jos ei kaksoispistettä, minuutit = 0

                const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + parseInt(dayAdd), h, m, 0, 0);

                // Alkuperäinen logiikka vuorokauden vaihteeseen
                if (isEnd && h === 23 && m === 59) d.setMinutes(60);

                return d.getTime();
            };

            const startLimit = getTs(document.getElementById("start_day").value, document.getElementById("start_time").value, false);
            const endLimit   = getTs(document.getElementById("end_day"  ).value, document.getElementById("end_time"  ).value, true);
            const nightStart = parseInt(document.getElementById('night_start').value) * 60;
            const nightEnd   = parseInt(document.getElementById('night_end'  ).value) * 60;

            // Rajataan myös nykyhetkeen: ei oteta mukaan menneisyyden hintoja
            const nowTs = now.getTime();
            const adjustedStart = Math.max(startLimit, nowTs);

            let windowPrices = sahkoHinnat
                .filter(h => h.ts >= adjustedStart && h.ts < endLimit)
                .map(p => ({ price: Number(p.price) || 0, ts: p.ts, date: p.date }));

            if (windowPrices.length < blocksNeeded) {
                showResultError(`Aikaikkuna on liian lyhyt. Tarve ${fiNumber.format(blocksNeeded/4)} h.`);
                return;
            }

            let minSum = Infinity;
            let bestStartIndex = 0;

            for (let i = 0; i <= windowPrices.length - blocksNeeded; i++) {
                let currentWindowSum = 0;
                for (let j = 0; j < blocksNeeded; j++) {
                    const p = Number(windowPrices[i + j].price);
                    const priceNum = isFinite(p) ? p : 0;
                    const siirtoHinta = isNightTime(windowPrices[i + j].date, nightStart, nightEnd) ? transferNight : transferDay;
                    currentWindowSum += priceNum + supplierMargin + siirtoHinta;
                }
                if (currentWindowSum < minSum) {
                    minSum = currentWindowSum;
                    bestStartIndex = i;
                }
            }

            if (!isFinite(minSum)) {
                showResultError("Hintojen laskennassa ilmeni virhe (tarkista hinnat).");
                return;
            }

            let avgPrice = minSum / blocksNeeded; // snt/kWh
            const EPS = 1e-9;
            if (Math.abs(avgPrice) < EPS) avgPrice = 0;

            const totalEuroRaw = (avgPrice * energyNeeded) / 100; // €
            const totalEuroRounded = Math.round(totalEuroRaw * 100) / 100;
            let totalDisplay;
            if (totalEuroRounded === 0 && Math.abs(totalEuroRaw) >= 0.005) {
                totalDisplay = totalEuroRaw > 0 ? '<0,01 €' : '>−0,01 €';
            } else {
                const sign = totalEuroRounded < 0 ? '-' : '';
                totalDisplay = sign + fiPrice.format(Math.abs(totalEuroRounded));
            }

            const avgFormatter = new Intl.NumberFormat('fi-FI', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            const avgDisplay = avgFormatter.format(avgPrice);

            const totalMinutes = Math.round(totalHoursExact * 60); // tai Math.ceil(...) jos haluat varman yliarvioinnin
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const minutesStr = minutes.toString().padStart(2, '0');
            const timeStr = hours > 0 ? `${hours} h ${minutesStr} min` : `${minutes} min`;

            const startData = windowPrices[bestStartIndex];
            const startTime = startData.date;
            const endTime = new Date(startTime.getTime() + blocksNeeded * 15 * 60000);
            const chargingPowerDisplay  = toFinnishString(chargingPower);
            const supplierMarginDisplay = toFinnishString(supplierMargin);
            const transferDayDisplay    = toFinnishString(transferDay);
            const transferNightDisplay  = toFinnishString(transferNight);

            const resDiv = document.getElementById('result');
            resDiv.style.display = "block";
            resDiv.innerHTML = `
                <div style="font-size:1.6rem; font-weight:bold">${car.name}</div>
                <div style="margin: 10px 0;">Tarve: ${fiNumber.format(energyNeeded)} kWh (${timeStr})</div>
                <div style="font-size:1.1rem; margin-bottom:6px;">Latausteho: <strong>${chargingPowerDisplay} kW</strong></div>
                <div style="font-size:1.8rem; color:#28a745; font-weight:bold;">
                    ${startTime.getDate()}.${startTime.getMonth()+1}. klo ${startTime.getHours()}:${startTime.getMinutes().toString().padStart(2,'0')} -<br>
                    ${endTime.getDate()}.${endTime.getMonth()+1}. klo ${endTime.getHours()}:${endTime.getMinutes().toString().padStart(2,'0')}
                </div>
                <div style="margin-top:10px;">
                    Hinta: <strong>${totalDisplay}</strong>
                    <small>(${avgDisplay} snt/kWh)</small>
                </div>
                <div style="margin-top:10px;">
                    Myyntimarginaali: <strong>${supplierMarginDisplay}</strong> snt/kWh
                </div>
                <div style="margin-top:10px;">
                    Päiväsiirron hinta: <strong>${transferDayDisplay}</strong> snt/kWh
                </div>
                <div style="margin-top:10px;">
                    Yösiirron hinta: <strong>${transferNightDisplay}</strong> snt/kWh
                </div>
            `;

            // Sulje mahdollinen kenttäfokus (poistaa mobiilin näppäimistön)
            if (document.activeElement && typeof document.activeElement.blur === 'function') {
                document.activeElement.blur();
            }

            // Odota hetki että UI päivittyy / näppäimistö häviää, sitten skrollaa tulokseen
            setTimeout(() => {
                if (typeof resDiv.scrollIntoView === 'function') {
                    resDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    window.scrollTo({ top: resDiv.offsetTop - 20, behavior: 'smooth' });
                }
            }, 120);
        }

        function isNightTime(currentDate, startMin, endMin) {
            if (isNaN(startMin) || isNaN(endMin)) return false;

            const currentMin = currentDate.getHours() * 60 + currentDate.getMinutes();

            if (startMin > endMin) {
                // Tapaus: Yöaika ylittää keskiyön (esim. 22:00 - 07:00)
                // On yö, jos kello on yli 22:00 TAI alle 07:00
                return currentMin >= startMin || currentMin < endMin;
            } else {
                // Tapaus: Yöaika on saman vuorokauden sisällä (esim. 00:00 - 06:00)
                return currentMin >= startMin && currentMin < endMin;
            }
        }

        function addCarInternal(name, capacity) {
            cars.push({ name, capacity });
            renderCars();
            const sel = document.getElementById('car_select');
            sel.value = cars.length - 1;
            saveAll();
        }

        function toggleAddCar() {
            const btn = document.getElementById('toggle_add_car');
            const panel = document.getElementById('add_car_panel');
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            if (expanded) closeAddCarPanel(); else openAddCarPanel();
        }

        function openAddCarPanel() {
            const btn = document.getElementById('toggle_add_car');
            const panel = document.getElementById('add_car_panel');
            panel.style.display = 'block';
            panel.setAttribute('aria-hidden', 'false');
            btn.setAttribute('aria-expanded', 'true');
            setTimeout(() => document.getElementById('new_car_name').focus(), 50);
        }

        function closeAddCarPanel() {
            const btn = document.getElementById('toggle_add_car');
            const panel = document.getElementById('add_car_panel');
            panel.style.display = 'none';
            panel.setAttribute('aria-hidden', 'true');
            btn.setAttribute('aria-expanded', 'false');
            btn.focus();
        }

        function addCarFromPanel() {
            const name = document.getElementById('new_car_name').value.trim();
            const cap = parseFloat(document.getElementById('new_car_cap').value);
            if (!name || !isFinite(cap) || cap <= 0) {
                alert('Anna kelvollinen nimi ja kapasiteetti (kWh).');
                return;
            }
            addCarInternal(name, cap);
            document.getElementById('new_car_name').value = '';
            document.getElementById('new_car_cap').value = '';
            closeAddCarPanel();
        }

        function deleteCar() {
            if (cars.length > 1) {
                if (confirm("Haluatko varmasti poistaa auton?")) {
                    const idx = parseInt(document.getElementById('car_select').value, 10);
                    cars.splice(idx, 1);
                    saveAll();
                    renderCars();
                }
            } else {
                alert('Vähintään yksi auto täytyy olla listassa.');
            }
        }

        function renderCars() {
            const sel = document.getElementById('car_select');
            const current = latausaikalaskuriAppState.selected_car_idx || 0;
            sel.innerHTML = cars.map((c, i) => `<option value="${i}" ${i==current?'selected':''}>${c.name} (${c.capacity}kWh)</option>`).join('');
            if (parseInt(sel.value,10) >= cars.length) sel.value = cars.length - 1;
        }

        function saveAll() {
            setAppStateByElements();
            localStorage.setItem('latausaikalaskuriAppState', JSON.stringify(latausaikalaskuriAppState));
        }

        function resetSettings() {
            if (confirm("Haluatko varmasti palauttaa oletusasetukset?")) {
                setDefaultAppState();
                localStorage.setItem('latausaikalaskuriAppState', JSON.stringify(latausaikalaskuriAppState));
                setElementsAndAppStateByLocalStorage();

                // 3. Tyhjennetään tulosnäyttö
                document.getElementById('result').innerHTML = "";

                alert("Asetukset palautettu oletusarvoihin!");
              //location.reload(); // Päivittää näkymän ja tyhjentää kentät
            }
        }

        function toggleSettings() {
            const menu    = document.getElementById('settings-menu');
            const overlay = document.getElementById('settings-overlay');
            const icon    = document.getElementById('settings-icon');

            if (menu.style.display !== 'block') {
                menu.style.display    = 'block';
                overlay.style.display = 'block';
                icon.style.display    = 'none';
                document.body.style.overflow = 'hidden'; // Estää taustan skrollauksen valikon ollessa auki
            } else {
                menu.style.display    = 'none';
                overlay.style.display = 'none';
                icon.style.display    = 'block';
                document.body.style.overflow = 'auto';
            }
        }

        function getAppState() {
            let appStateStr = localStorage.getItem(`latausaikalaskuriAppState`);
            if (appStateStr) {
                return JSON.parse(appStateStr);
            }

            let appState = getDefaultAppState();
            localStorage.setItem('latausaikalaskuriAppState', JSON.stringify(appState));
            return appState;
        }

        function setDefaultAppState() {
            latausaikalaskuriAppState = getDefaultAppState();
        }

        function getDefaultAppState() {
            return {
                supplier_margin:  0.39,
                cars:             defaultCars,
                selected_car_idx: 0,
                charge:           0,
                target:           80,
                transfer_day:     6.12752,
                transfer_night:   4.24752,
                night_start:      "22",
                night_end:        "07",
                charging_power:   11
            };
        }

        function setElementsAndAppStateByLocalStorage() {
            const savedData = localStorage.getItem(`latausaikalaskuriAppState`);
            if (savedData) {
                latausaikalaskuriAppState = JSON.parse(savedData);
                cars                                             = latausaikalaskuriAppState.cars;
                document.getElementById('car_select'     ).value = latausaikalaskuriAppState.selected_car_idx;
                document.getElementById('charge'         ).value = toFinnishString(latausaikalaskuriAppState.charge);
                document.getElementById('target'         ).value = toFinnishString(latausaikalaskuriAppState.target);
                document.getElementById('supplier_margin').value = toFinnishString(latausaikalaskuriAppState.supplier_margin);
                document.getElementById('transfer_day'   ).value = toFinnishString(latausaikalaskuriAppState.transfer_day);
                document.getElementById('transfer_night' ).value = toFinnishString(latausaikalaskuriAppState.transfer_night);
                document.getElementById('night_start'    ).value = latausaikalaskuriAppState.night_start;
                document.getElementById('night_end'      ).value = latausaikalaskuriAppState.night_end;
                document.getElementById('charging_power' ).value = toFinnishString(latausaikalaskuriAppState.charging_power);
            }
        }

        function setAppStateByElements() {
            // Luodaan yksi objekti, joka sisältää kaiken tilatiedon
            latausaikalaskuriAppState = {
                supplier_margin:  parseFinnishFloat(document.getElementById('supplier_margin').value),
                cars:             cars,
                selected_car_idx: parseFinnishFloat(document.getElementById('car_select').value),
                charge:           parseFinnishFloat(document.getElementById('charge').value),
                target:           parseFinnishFloat(document.getElementById('target').value),
                transfer_day:     parseFinnishFloat(document.getElementById('transfer_day').value),
                transfer_night:   parseFinnishFloat(document.getElementById('transfer_night').value),
                night_start:      document.getElementById(`night_start`).value,
                night_end:        document.getElementById(`night_end`).value,
                charging_power:   parseFinnishFloat(document.getElementById('charging_power').value)
            };
        }

        function toFinnishString(value) {
            if (value === undefined || value === null) return "";
            return value.toString().replace('.', ',');
        }

        function parseFinnishFloat(value) {
            if (typeof value === 'string') {
                const normalized = value.replace(',', '.');
                return parseFloat(normalized) || 0;
            }
            return value;
        }

        document.querySelectorAll('.finnish-number').forEach(input => {
            input.addEventListener('input', function() {
                // Sallitaan vain numerot ja yksi erotin, muutetaan piste pilkuksi
                let v = this.value.replace(/[^0-9.,]/g, '').replace(/\./g, ',');
                const parts = v.split(',');
                this.value = parts.length > 2 ? parts[0] + ',' + parts.slice(1).join('') : v;
            });
        });

        window.onload = () => {
            setElementsAndAppStateByLocalStorage();

            const supplierMarginEl = document.getElementById('supplier_margin');
            if (supplierMarginEl) {
                supplierMarginEl.addEventListener('blur', () => {
                    if (supplierMarginEl.value.includes('.')) supplierMarginEl.value = supplierMarginEl.value.replace(/\./g, ',');
                });
            }
            const powerEl = document.getElementById('charging_power');
            powerEl.addEventListener('blur', () => {
                if (powerEl.value.includes('.')) powerEl.value = powerEl.value.replace(/\./g, ',');
            });

            closeAddCarPanel();
            renderCars();
            fetchPrices();
        };

        function saveSettings() {
            saveAll();
            alert('Asetukset tallennettu.');
        }
    </script>
</body>
</html>
