<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Latausaikalaskuri ja Hinta-analyysi</title>
    <style>
        :root {
            --font-size-small: 72px;
            --font-size-medium: 80px;
            --font-size-large: 96px;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 18px;
        }
        h2 {
            font-size: var(--font-size-large);
        }
        .input-group {
            margin-bottom: 10px;
        }
        label {
            font-size: var(--font-size-small);
            display: block;
            margin-bottom: 5px;
        }
        input, button {
            font-size: var(--font-size-small);
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        .result-car {
            border: 2px solid #ccc;
            padding: 10px;
            margin-top: 15px;
        }
        .result-title {
            font-size: var(--font-size-medium);
            font-weight: bold;
            margin-bottom: 5px;
        }
        .result-detail {
            font-size: var(--font-size-small);
            margin-bottom: 5px;
        }
        .optimized {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: normal;
        }
        #price_status {
            font-size: var(--font-size-small);
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h2>Latausaikalaskuri</h2>
        
    <div class="input-group">
        <label for="charge">Jäljellä oleva lataus (%):</label>
        <input type="number" id="charge" min="0" max="100" required>
    </div>
        
    <div class="input-group">
        <label for="target">Tavoitelataus (%):</label>
        <input type="number" id="target" min="0" max="100" value="80" required>
    </div>
        
    <div class="input-group">
        <label for="margin">Myyjän marginaali (snt/kWh):</label>
        <input type="number" id="margin" min="0" step="0.01" value="0.30">
    </div>
        
    <div class="input-group">
        <button onclick="calculateChargingTime()">Laske</button>
    </div>

    <p id="price_status">Ladataan hintoja... ⏳</p>

    <div id="result_etron" class="result-car"></div>
    <div id="result_id4" class="result-car"></div>

    <script>
        let sahkoHinnat = []; 
        const PRICE_STATUS_ELEMENT = document.getElementById('price_status');

        const CAR_MODELS = {
            etron: { name: "Audi e-tron", capacity: 95 }, 
            id4: { name: "VW ID.4", capacity: 77 }       
        };
        const chargingPower = 10.8; 
        const INTERVAL_MINUTES = 15; 
        const INTERVALS_PER_HOUR = 60 / INTERVAL_MINUTES; 
        const FIXED_INTERVALS = 24 * INTERVALS_PER_HOUR; // 96 jaksoa päivässä

        // ------------------------------------------------------------------
        // LOCAL STORAGE: TALLENNUS
        // ------------------------------------------------------------------
        function saveValues(charge, target, margin) {
            try {
                localStorage.setItem('charge_value', charge);
                localStorage.setItem('target_value', target);
                localStorage.setItem('margin_value', margin); 
            } catch (e) {
                console.error("Local Storage tallennus epäonnistui:", e);
            }
        }
        
        // ------------------------------------------------------------------
        // LOCAL STORAGE: LATAUS
        // ------------------------------------------------------------------
        function loadSavedValues() {
            try {
                const savedCharge = localStorage.getItem('charge_value');
                const savedTarget = localStorage.getItem('target_value');
                const savedMargin = localStorage.getItem('margin_value'); 

                if (savedCharge !== null) {
                    document.getElementById('charge').value = savedCharge;
                }
                if (savedTarget !== null) {
                    document.getElementById('target').value = savedTarget;
                }
                if (savedMargin !== null) {
                    document.getElementById('margin').value = savedMargin;
                }
            } catch (e) {
                console.error("Local Storage lataus epäonnistui:", e);
            }
        }

        // ------------------------------------------------------------------
        // FUNKTIO: Hintojen Haku (Käyttää /Today ja /DayForward)
        // ------------------------------------------------------------------
        async function fetchPrices() {
            
            PRICE_STATUS_ELEMENT.innerText = 'Ladataan hintoja... ⏳';
            let allData = [];
            let lastDateTimeRaw = null;

            try {
                // 1. HAKU: /Today (Tämän päivän hinnat)
                let responseToday = await fetch('https://api.spot-hinta.fi/Today');
                if (!responseToday.ok) throw new Error(`HTTP error! status: ${responseToday.status} (/Today)`);
                let dataToday = await responseToday.json();
                
                if (Array.isArray(dataToday) && dataToday.length >= FIXED_INTERVALS) {
                    // Otetaan vain 24h jakso Today-datasta
                    allData = dataToday.slice(0, FIXED_INTERVALS);
                    lastDateTimeRaw = allData[allData.length - 1].DateTime;
                } else {
                    throw new Error("Ladatussa /Today-datassa ei ollut riittävästi jaksoja.");
                }
                
                // 2. HAKU: /DayForward (Seuraavan päivän hinnat)
                // Jos DayForward ei ole saatavilla (esim. ennen klo 15), se heittää virheen ja käytetään vain Today-dataa
                
                let responseDayForward = await fetch('https://api.spot-hinta.fi/DayForward');
                if (responseDayForward.ok) {
                    let dataDayForward = await responseDayForward.json();
                    
                    if (Array.isArray(dataDayForward) && dataDayForward.length >= FIXED_INTERVALS) {
                         // Otetaan vain 24h jakso DayForward-datasta ja yhdistetään Today-dataan
                        allData = allData.concat(dataDayForward.slice(0, FIXED_INTERVALS));
                        lastDateTimeRaw = dataDayForward.slice(0, FIXED_INTERVALS)[FIXED_INTERVALS - 1].DateTime;
                    } 
                    // Jos DayForward palauttaa OK mutta datassa ei ole 96 jaksoa, käytetään vain allData (eli Today)
                    
                } // Jos DayForward ei palauta OK (esim. 404 tai 500), käytetään vain allData (eli Today)
                
                
                // --- Käsittely ---
                sahkoHinnat = allData.map(item => parseFloat(item.PriceWithTax) * 100); 
                
                if (sahkoHinnat.some(isNaN)) {
                     throw new Error("API palautti virheellisiä hintatietoja.");
                }
                
                // --- PÄIVÄMÄÄRÄN JA KELLONAJAN MUOTOILU ---
                const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Helsinki' };
                const dateOptions = { year: 'numeric', month: 'numeric', day: 'numeric', timeZone: 'Europe/Helsinki' };
                
                const lastDateTime = new Date(lastDateTimeRaw);
                // Lisätään 15 minuuttia, jotta saadaan viimeisen jakson päättymisaika (esim. klo 24:00)
                lastDateTime.setMinutes(lastDateTime.getMinutes() + 15);
                
                const dateString = lastDateTime.toLocaleDateString('fi-FI', dateOptions);
                const timeString = lastDateTime.toLocaleTimeString('fi-FI', timeOptions);
                
                PRICE_STATUS_ELEMENT.innerText = `✅ Hinnat ladattu ${dateString} klo ${timeString} asti. (${sahkoHinnat.length} jaksoa)`;
                PRICE_STATUS_ELEMENT.style.color = 'green';
                
            } catch (error) {
                console.error("Hintojen haku epäonnistui:", error);
                
                // Tarkistetaan, saatiinko vähintään Today-data (FIXED_INTERVALS)
                if (sahkoHinnat.length >= FIXED_INTERVALS) {
                    PRICE_STATUS_ELEMENT.innerText = `⚠️ Ladattu vain tämän päivän hinnat (${FIXED_INTERVALS} jaksoa).`;
                    PRICE_STATUS_ELEMENT.style.color = 'orange';
                } else {
                    PRICE_STATUS_ELEMENT.innerText = '❌ Hintojen haku epäonnistui kokonaan. Vain latausaika lasketaan.';
                    PRICE_STATUS_ELEMENT.style.color = 'red';
                    sahkoHinnat = []; 
                }
            }
        }


        // ------------------------------------------------------------------
        // FUNKTIO: Halvimman ajankohdan etsiminen 
        // ------------------------------------------------------------------
        function haeEdullisinLatausajankohta(tarvittavat_jaksot, hinnat, marginaali_snt) {
            
            if (tarvittavat_jaksot <= 0 || tarvittavat_jaksot > hinnat.length) {
                return null;
            }

            let alinKokonaisHintaSumma = Infinity;
            let optimaalinenAloitusJakso = -1;

            for (let alkuJakso = 0; alkuJakso <= hinnat.length - tarvittavat_jaksot; alkuJakso++) {
                let nykyinenKokonaisHintaSumma = 0;
                
                for (let i = 0; i < tarvittavat_jaksot; i++) {
                    const jaksoIndeksi = alkuJakso + i;
                    const lopullinen_hinta = hinnat[jaksoIndeksi] + marginaali_snt; 
                    nykyinenKokonaisHintaSumma += lopullinen_hinta;
                }
                
                if (nykyinenKokonaisHintaSumma < alinKokonaisHintaSumma) {
                    alinKokonaisHintaSumma = nykyinenKokonaisHintaSumma;
                    optimaalinenAloitusJakso = alkuJakso;
                }
            }

            if (optimaalinenAloitusJakso !== -1) {
                const keskihinta_snt_kWh = alinKokonaisHintaSumma / tarvittavat_jaksot;
                
                // HUOM: Tässä lasketaan aika jaksojen perusteella, koska data voi olla yli 24h
                const aloitusaika = new Date(0, 0, 0, Math.floor(optimaalinenAloitusJakso / INTERVALS_PER_HOUR), (optimaalinenAloitusJakso % INTERVALS_PER_HOUR) * INTERVAL_MINUTES);
                const loppuaikaJakso = optimaalinenAloitusJakso + tarvittavat_jaksot;
                const loppuaika = new Date(0, 0, 0, Math.floor(loppuaikaJakso / INTERVALS_PER_HOUR), (loppuaikaJakso % INTERVALS_PER_HOUR) * INTERVAL_MINUTES);
                
                const formatTime = (date) => date.toTimeString().slice(0, 5);
                const aloitusaikaTeksti = `${formatTime(aloitusaika)} - ${formatTime(loppuaika)}`;
                
                return {
                    aloitusaika: aloitusaikaTeksti,
                    keskihinta_snt_kWh: keskihinta_snt_kWh
                };
            }

            return null;
        }

        // ------------------------------------------------------------------
        // PÄÄFUNKTIO: Latausajan ja Kustannuksen laskenta
        // ------------------------------------------------------------------
        function calculateChargingTime() {
            
            const chargeElement = document.getElementById("charge");
            const targetElement = document.getElementById("target");
            const marginElement = document.getElementById("margin");
            
            const remainingCharge = parseFloat(chargeElement.value);
            const targetCharge = parseFloat(targetElement.value || 80);
            const marginValue = parseFloat(marginElement.value || 0);
            
            if (isNaN(remainingCharge) || isNaN(targetCharge) || (targetCharge - remainingCharge) <= 0 || remainingCharge < 0 || targetCharge > 100 || isNaN(marginValue) || marginValue < 0) {
                const virheHTML = `<div class="result-title">Virhe</div>Tarkista latausprosentit ja marginaali.`;
                document.getElementById("result_etron").innerHTML = virheHTML;
                document.getElementById("result_id4").innerHTML = virheHTML;
                return;
            }
            
            saveValues(remainingCharge, targetCharge, marginValue);

            for (const [key, car] of Object.entries(CAR_MODELS)) {
                
                const remainingCapacity_kWh = car.capacity * ((targetCharge - remainingCharge) / 100);
                const timeInHours = remainingCapacity_kWh / chargingPower;

                const hours = Math.floor(timeInHours);
                const minutes = Math.round((timeInHours - hours) * 60);
                
                const timeInMinutes = timeInHours * 60;
                const tarvittavat_jaksot = Math.ceil(timeInMinutes / INTERVAL_MINUTES); 
                
                let tulosHTML = `
                    <div class="result-title">${car.name} (${car.capacity} kWh)</div>
                    <div class="result-detail">Tarvittava latausaika: ${hours} h ${minutes} min (Latausteho ${chargingPower.toFixed(1)} kW)</div>
                `;

                if (sahkoHinnat.length >= FIXED_INTERVALS) { 
                    
                    if (tarvittavat_jaksot > sahkoHinnat.length) { 
                         tulosHTML += `<div class="result-detail warning">Latausaika (${hours} h ${minutes} min) on pidempi kuin saatavilla oleva hintaennuste (${sahkoHinnat.length} jaksoa). Optimointi on epätäydellinen.</div>`;
                    } else {
                    
                        const edullisinAjankohtaTulos = haeEdullisinLatausajankohta(tarvittavat_jaksot, sahkoHinnat, marginValue);
                        
                        if (edullisinAjankohtaTulos) {
                            const optimaalinenKeskihinta = edullisinAjankohtaTulos.keskihinta_snt_kWh;
                            const optimaalinenKokonaisKustannus_eur = (optimaalinenKeskihinta * remainingCapacity_kWh) / 100;
                            
                            tulosHTML += `
                                <div class="result-detail optimized">Edullisin ajankohta: ${edullisinAjankohtaTulos.aloitusaika}</div>
                                <div class="result-detail optimized">Optimaalinen kustannus: ${optimaalinenKokonaisKustannus_eur.toFixed(2)} € (Keskihinta ${optimaalinenKeskihinta.toFixed(2)} snt/kWh, sis. ${marginValue.toFixed(2)} snt/kWh marginaalin)</div>
                            `;
                        } else {
                            tulosHTML += `<div class="result-detail warning">Optimointi epäonnistui (Jakson haku palautti nullin).</div>`;
                        }
                    }
                } else {
                    tulosHTML += `<div class="result-detail warning">Hinta-analyysiä ei voitu suorittaa (Hintoja ei saatavilla).</div>`;
                }

                document.getElementById(`result_${key}`).innerHTML = tulosHTML;
            }
        }

        // ------------------------------------------------------------------
        // ALUSTUS
        // ------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedValues(); 
            fetchPrices();
        });
    </script>
</body>
</html>
