<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latausaikalaskuri</title>
    <style>
        :root {
            /* Säädetyt fontit: silti suuret, mutta standardimmat */
            --font-size-small: 1.5rem;  /* n. 24px */
            --font-size-medium: 2rem;   /* n. 32px */
            --font-size-large: 2.5rem;  /* n. 40px */
        }

        /* Jos näyttö on suuri (tietokone), fontit voivat olla vielä isompia */
        @media screen and (min-width: 800px) {
            :root {
                --font-size-small: 2.5rem;
                --font-size-medium: 3.5rem;
                --font-size-large: 4.5rem;
            }
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.4;
            color: #333;
        }

        h2 {
            font-size: var(--font-size-large);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            font-size: var(--font-size-small);
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input, button {
            font-size: var(--font-size-small);
            padding: 15px;
            width: 100%;
            box-sizing: border-box;
            border: 2px solid #ccc;
            border-radius: 8px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Aikavälikentät allekkain mobiilissa, vierekkäin tietokoneella */
        .time-range {
            display: flex;
            gap: 15px;
            flex-direction: column;
        }

        @media screen and (min-width: 600px) {
            .time-range {
                flex-direction: row;
            }
        }

        .time-range div {
            flex: 1;
        }

        .result-car {
            border: 3px solid #007bff;
            padding: 20px;
            margin-top: 25px;
            border-radius: 12px;
            background-color: #f8f9fa;
        }

        .result-title {
            font-size: var(--font-size-medium);
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 10px;
        }

        .result-detail {
            font-size: var(--font-size-small);
            margin-bottom: 8px;
        }

        .optimized {
            color: #28a745;
            font-weight: bold;
        }

        .warning {
            color: #dc3545;
        }

        #price_status {
            font-size: 1.2rem;
            margin-top: 15px;
            font-style: italic;
        }

        .help-text {
            font-size: 1rem;
            color: #666;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <h2>Latausaikalaskuri</h2>

    <div class="input-group">
        <label for="charge">Jäljellä oleva lataus (%):</label>
        <input type="number" id="charge" min="0" max="100" required>
    </div>

    <div class="input-group">
        <label for="target">Tavoitelataus (%):</label>
        <input type="number" id="target" min="0" max="100" value="80" required>
    </div>

    <div class="input-group">
        <label>Latausikkuna (24h):</label>
        <p class="help-text">Esim. 22:00 tai 07:30</p>
        <div class="time-range">
            <div>
                <label style="font-size: 1.2rem;">Alkaen</label>
                <input type="text" id="start_time" value="00:00" maxlength="5">
            </div>
            <div>
                <label style="font-size: 1.2rem;">Päättyen</label>
                <input type="text" id="end_time" value="23:59" maxlength="5">
            </div>
        </div>
    </div>

    <div class="input-group">
        <label for="margin">Marginaali (snt/kWh):</label>
        <input type="number" id="margin" min="0" step="0.01" value="0.30">
    </div>

    <button onclick="calculateChargingTime()">Laske</button>

    <p id="price_status">Ladataan hintoja... ⏳</p>

    <div id="result_etron" class="result-car"></div>
    <div id="result_id4" class="result-car"></div>

    <script>
        // JS-logiikka pysyy samana kuin edellisessä, poistettu vain piste-bugi ja pidetty 24h
        let sahkoHinnat = [];
        const CAR_MODELS = {
            etron: { name: "Audi e-tron", capacity: 95 }, 
            id4: { name: "VW ID.4", capacity: 77 } 
        };
        const chargingPower = 10.8;
        const INTERVALS_PER_HOUR = 4;

        async function fetchPrices() {
            try {
                let resT = await fetch('https://api.spot-hinta.fi/Today');
                let dataT = await resT.json();
                let resF = await fetch('https://api.spot-hinta.fi/DayForward');
                let dataF = resF.ok ? await resF.json() : [];
                
                let allData = dataT.concat(dataF);
                const now = new Date();

                sahkoHinnat = allData.map(item => ({
                    price: parseFloat(item.PriceWithTax) * 100,
                    dateTime: new Date(item.DateTime)
                })).filter(item => item.dateTime >= now);

                if (sahkoHinnat.length > 0) {
                    const last = new Date(sahkoHinnat[sahkoHinnat.length-1].dateTime.getTime() + 15*60000);
                    document.getElementById('price_status').innerText = `✅ Hinnat ladattu ${last.toLocaleDateString('fi-FI')} klo ${last.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'})} asti.`;
                    document.getElementById('price_status').style.color = "green";
                }
            } catch (e) {
                document.getElementById('price_status').innerText = "❌ Hintojen haku epäonnistui.";
            }
        }

        function calculateChargingTime() {
            const charge = parseFloat(document.getElementById("charge").value);
            const target = parseFloat(document.getElementById("target").value);
            const margin = parseFloat(document.getElementById("margin").value || 0);
            const startStr = document.getElementById("start_time").value;
            const endStr = document.getElementById("end_time").value;

            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!timeRegex.test(startStr) || !timeRegex.test(endStr)) {
                alert("Virheellinen aika!"); return;
            }

            const [sH, sM] = startStr.split(':').map(Number);
            const [eH, eM] = endStr.split(':').map(Number);
            const startLimit = sH * 60 + sM;
            const endLimit = eH * 60 + eM;

            const filtered = sahkoHinnat.filter(item => {
                const cur = item.dateTime.getHours() * 60 + item.dateTime.getMinutes();
                return startLimit <= endLimit ? (cur >= startLimit && cur < endLimit) : (cur >= startLimit || cur < endLimit);
            });

            for (const [key, car] of Object.entries(CAR_MODELS)) {
                const energy = car.capacity * ((target - charge) / 100);
                const intervals = Math.ceil((energy / chargingPower) * INTERVALS_PER_HOUR);
                let resDiv = document.getElementById(`result_${key}`);

                if (intervals > filtered.length) {
                    resDiv.innerHTML = `<div class="result-title">${car.name}</div><div class="result-detail warning">Ikkuna liian lyhyt!</div>`;
                    continue;
                }

                let bestSum = Infinity, bestIdx = -1;
                for (let i = 0; i <= filtered.length - intervals; i++) {
                    let sum = 0;
                    for (let j = 0; j < intervals; j++) sum += filtered[i+j].price + margin;
                    if (sum < bestSum) { bestSum = sum; bestIdx = i; }
                }

                const s = filtered[bestIdx].dateTime;
                const e = new Date(s.getTime() + intervals * 15 * 60000);
                const avg = bestSum / intervals;

                resDiv.innerHTML = `
                    <div class="result-title">${car.name}</div>
                    <div class="result-detail">Tarve: ${energy.toFixed(1)} kWh</div>
                    <div class="result-detail optimized">Edullisin: ${s.toLocaleDateString('fi-FI')} klo ${s.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit', hour12:false})} - ${e.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit', hour12:false})}</div>
                    <div class="result-detail optimized">Kustannus: ${(avg * energy / 100).toFixed(2)} € (Ka. ${avg.toFixed(2)} snt)</div>
                `;
            }
        }

        window.onload = () => { fetchPrices(); };
    </script>
</body>
</html>
